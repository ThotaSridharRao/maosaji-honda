<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Maosaji Honda - User Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet">
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<script>
tailwind.config = {
    theme: {
        extend: {
            colors: {
                primary: '#e31837', /* Honda's primary red color */
                secondary: '#000000' /* Dark grey for text */
            },
            borderRadius: {
                'none': '0px',
                'sm': '4px',
                DEFAULT: '8px',
                'md': '12px',
                'lg': '16px',
                'xl': '20px',
                '2xl': '24px',
                '3xl': '32px',
                'full': '9999px',
                'button': '8px' /* Custom border-radius for buttons */
            }
        }
    }
};
</script>
<style>
/* Reset Remixicon content to allow individual icon display */
:where([class^="ri-"])::before { content: initial; } /* Remove default content to allow specific icon classes to work */

body {
    font-family: 'Poppins', sans-serif;
    scroll-behavior: smooth;
}
.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #f0f9ff 0%, #e1f5fe 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    opacity: 1;
    transition: opacity 0.5s ease-out;
}
.loader {
    position: relative;
    width: 120px;
    height: 120px;
}
.loader-circle {
    position: absolute;
    width: 100%;
    height: 100%;
    border: 4px solid transparent;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
.loader-circle:nth-child(2) {
    width: 80%;
    height: 80%;
    top: 10%;
    left: 10%;
    border-top-color: #10b981;
    animation-duration: 1.3s;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.logo-pulse {
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}
.fade-in {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.8s ease, transform 0.8s ease;
}
.fade-in.appear {
    opacity: 1;
    transform: translateY(0);
}
.vehicle-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.vehicle-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
}
.vehicle-icon {
    transition: transform 0.3s ease;
}
.vehicle-card:hover .vehicle-icon {
    transform: scale(1.1);
}
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
.custom-checkbox {
    position: relative;
    display: inline-block;
    width: 20px;
    height: 20px;
    background-color: #fff;
    border: 2px solid #d1d5db;
    border-radius: 4px;
    transition: all 0.2s ease;
}
.custom-checkbox.checked {
    background-color: #3b82f6;
    border-color: #3b82f6;
}
.custom-checkbox.checked::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 6px;
    width: 6px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}
.custom-switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 24px;
}
.switch-track {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #e5e7eb;
    border-radius: 24px;
    transition: background-color 0.3s ease;
}
.switch-thumb {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 20px;
    height: 20px;
    background-color: white;
    border-radius: 50%;
    transition: transform 0.3s ease;
    box-shadow: 0 1px 3px (0, 0, 0, 0.1);
}
.switch-active .switch-track {
    background-color: #3b82f6;
}
.switch-active .switch-thumb {
    transform: translateX(24px);
}
/* Custom Message Box Styles */
.message-box {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #4CAF50; /* Green for success */
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
    min-width: 250px;
    text-align: center;
}
.message-box.error {
    background-color: #f44336; /* Red for error */
}
.message-box.show {
    opacity: 1;
}

/* Status colors for services */
.status-pending { background-color: #fef3c7; color: #d97706; } /* yellow-100, yellow-700 */
.status-in-progress { background-color: #bfdbfe; color: #1d4ed8; } /* blue-200, blue-800 */
.status-completed { background-color: #d1fae5; color: #065f46; } /* green-100, green-800 */
.status-ready-for-pickup { background-color: #bae6fd; color: #0369a1; } /* lightblue-100, lightblue-800 */
.status-cancelled { background-color: #fee2e2; color: #b91c1c; } /* red-100, red-700 */
.status-picked-up { background-color: #e0f2f7; color: #00838f; } /* teal-100, teal-700, custom for picked-up */


/* Confirmation Modal Styles */
.confirmation-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10001;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
}
.confirmation-modal.show {
    opacity: 1;
    visibility: visible;
}
.confirmation-modal-content {
    background-color: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    text-align: center;
    max-width: 400px;
    width: 90%;
    transform: translateY(20px);
    transition: transform 0.3s ease-in-out;
}
.confirmation-modal.show .confirmation-modal-content {
    transform: translateY(0);
}
</style>
</head>
<body>
<!-- Loading Screen -->
<div class="loading-screen" id="loading-screen">
    <div class="flex flex-col items-center">
        <div class="logo-pulse text-4xl font-['Pacifico'] text-primary mb-4">Maosaji Honda</div>
        <div class="loader">
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
        </div>
        <p class="mt-4 text-gray-600">Loading your dashboard...</p>
    </div>
</div>

<!-- Custom Message Box Container -->
<div id="custom-message-box" class="message-box hidden"></div>

<!-- Confirmation Modal -->
<div id="confirmation-modal" class="confirmation-modal">
    <div class="confirmation-modal-content">
        <h3 class="text-xl font-semibold mb-4 text-gray-800" id="confirmation-modal-title">Confirm Action</h3>
        <p class="text-gray-600 mb-6" id="confirmation-modal-message">Are you sure you want to proceed?</p>
        <div class="flex justify-center space-x-4">
            <button id="confirm-yes" class="px-6 py-3 bg-red-500 text-white rounded-button font-medium hover:bg-red-600 transition-colors">Yes</button>
            <button id="confirm-no" class="px-6 py-3 bg-gray-300 text-gray-800 rounded-button font-medium hover:bg-gray-400 transition-colors">No</button>
        </div>
    </div>
</div>

<!-- Navigation (Header) -->
<nav class="bg-white shadow-md fixed w-full z-50 transition-all duration-300" id="navbar">
    <div class="container mx-auto px-4 py-3">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-2">
                <img src="https://static.readdy.ai/image/37ac7cf2068439d6c30c12e5ad957f85/cf039908287dcf84123e6dde02bea2bc.png" alt="Honda Logo" class="h-8">
                <a href="#" class="text-2xl font-bold text-primary">Maosaji Honda</a>
            </div>
            <div class="hidden md:flex items-center space-x-8">
              <a href="index.html" class="text-gray-700 hover:text-primary transition-colors duration-300">Home</a>
                <a href="#my-vehicles" class="text-gray-700 hover:text-primary transition-colors duration-300">My Vehicles</a>
                <a href="#add-vehicle" class="text-gray-700 hover:text-primary transition-colors duration-300">Add Vehicle</a>
                <a href="#my-services" class="text-gray-700 hover:text-primary transition-colors duration-300">My Services</a>
                <a href="#profile" class="text-gray-700 hover:text-primary transition-colors duration-300">Profile</a>
                <button id="logout-button" class="px-4 py-2 text-primary border border-primary hover:bg-primary hover:text-white transition-colors duration-300 !rounded-button whitespace-nowrap">Log Out</button>
            </div>
            <div class="md:hidden flex items-center">
                <button id="mobile-menu-button" class="w-10 h-10 flex items-center justify-center text-gray-500 hover:text-primary">
                    <i class="ri-menu-line ri-lg"></i>
                </button>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="md:hidden hidden mt-4 pb-2">
            <div class="flex flex-col space-y-3">
              <a href="index.html" class="text-gray-700 hover:text-primary py-2 transition-colors duration-300">Home</a>
                <a href="#my-vehicles" class="text-gray-700 hover:text-primary py-2 transition-colors duration-300">My Vehicles</a>
                <a href="#add-vehicle" class="text-gray-700 hover:text-primary py-2 transition-colors duration-300">Add Vehicle</a>
                <a href="#my-services" class="text-gray-700 hover:text-primary py-2 transition-colors duration-300">My Services</a>
                <a href="#profile" class="text-gray-700 hover:text-primary py-2 transition-colors duration-300">Profile</a>
                <button id="logout-button-mobile" class="px-4 py-2 text-primary border border-primary hover:bg-primary hover:text-white transition-colors duration-300 !rounded-button whitespace-nowrap">Log Out</button>
            </div>
        </div>
    </div>
</nav>

<!-- User Dashboard Main Content -->
<main class="pt-24 pb-12 bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4">
        <!-- Welcome Section -->
        <section class="mb-12 fade-in">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4">Welcome, <span id="user-name">User</span>!</h1>
            <p class="text-lg text-gray-600">Manage your vehicles and services efficiently.</p>
        </section>

        <!-- My Vehicles Section -->
        <section id="my-vehicles" class="py-12 bg-white rounded-lg shadow-md mb-12 fade-in">
            <div class="px-8 py-6 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">My Motorcycles</h2>
                <button id="show-add-vehicle-form" class="px-4 py-2 bg-primary text-white rounded-button font-medium hover:bg-opacity-90 transition-all flex items-center">
                    <i class="ri-add-line mr-2"></i> Add New Vehicle
                </button>
            </div>
            <div id="vehicles-list" class="p-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Vehicle cards will be dynamically loaded here -->
            </div>
            <!-- Message for no vehicles -->
            <div id="no-vehicles-message" class="p-8 text-center text-gray-500 hidden">
                <i class="ri-emotion-normal-line text-6xl mb-4"></i>
                <p class="text-xl font-medium mb-4">No vehicles added yet!</p>
                <p>Click "Add New Vehicle" to get started.</p>
            </div>
        </section>

        <!-- Add New Vehicle Section -->
        <section id="add-vehicle" class="py-12 bg-white rounded-lg shadow-md fade-in">
            <div class="px-8 py-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">Add New Motorcycle</h2>
            </div>
            <form id="add-vehicle-form" class="p-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="vehicle-make" class="block text-gray-700 mb-2">Make</label>
                        <input type="text" id="vehicle-make" class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Honda" required>
                    </div>
                    <div>
                        <label for="vehicle-model" class="block text-gray-700 mb-2">Model</label>
                        <input type="text" id="vehicle-model" class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="CBR600RR" required>
                    </div>
                    <div>
                        <label for="vehicle-year" class="block text-gray-700 mb-2">Year</label>
                        <input type="number" id="vehicle-year" class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="2020" required min="1900" max="2099">
                    </div>
                    <div>
                        <label for="license-plate" class="block text-gray-700 mb-2">License Plate</label>
                        <input type="text" id="license-plate" class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="KA01AB1234" required>
                    </div>
                </div>
                <button type="submit" class="px-6 py-3 bg-primary text-white rounded-button font-medium hover:bg-opacity-90 transition-all flex items-center justify-center">
                    <i class="ri-save-line mr-2"></i> Save Vehicle
                </button>
            </form>
        </section>

        <!-- My Services Section -->
        <section id="my-services" class="py-12 bg-white rounded-lg shadow-md mt-12 fade-in">
            <div class="px-8 py-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">My Services</h2>
            </div>
            <div class="p-8">
                <!-- Current Servicing Status - Dynamically loaded -->
                <div id="current-service-status-container" class="mb-8 hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Current Servicing Status</h3>
                    <!-- Dynamic content will go here -->
                </div>
                <!-- Message for no current service -->
                <div id="no-current-service-message" class="p-4 text-center text-gray-500">
                    <i class="ri-information-line text-5xl mb-3"></i>
                    <p class="text-md font-medium">No vehicle currently in service.</p>
                </div>


                <!-- Servicing History - Dynamically loaded -->
                <div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Servicing History</h3>
                    <div id="service-history-list">
                        <!-- Service history items will be dynamically loaded here -->
                    </div>
                    <!-- Message for no service history -->
                    <div id="no-service-history-message" class="p-4 text-center text-gray-500 hidden">
                        <i class="ri-file-text-line text-5xl mb-3"></i>
                        <p class="text-md font-medium">No service history found.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Profile Section (Placeholder - could be expanded later) -->
        <section id="profile" class="py-12 bg-white rounded-lg shadow-md mt-12 fade-in">
            <div class="px-8 py-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">My Profile</h2>
            </div>
            <div class="p-8 text-center text-gray-500">
                <i class="ri-user-settings-line text-6xl mb-4"></i>
                <p class="text-xl font-medium mb-4">Profile Management Under Construction</p>
                <p>Soon you'll be able to update your personal details and preferences here.</p>
            </div>
        </section>
    </div>
</main>

<!-- Map Section (Copied from index.html) -->
<section class="h-96 relative overflow-hidden">
    <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('https://public.readdy.ai/gen_page/map_placeholder_1280x720.png');"></div>
    <div class="absolute inset-0 bg-black bg-opacity-20 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full text-center">
            <h3 class="text-2xl font-semibold mb-4">Visit Our Location</h3>
            <p class="text-gray-600 mb-6">We're conveniently located in the heart of Automotive City with easy access and ample parking.</p>
            <button class="px-6 py-3 bg-primary text-white hover:bg-blue-600 transition-colors duration-300 !rounded-button whitespace-nowrap">
                <i class="ri-navigation-line mr-2"></i> Get Directions
            </button>
        </div>
    </div>
</section>

<!-- Footer (Copied from index.html) -->
<footer class="bg-gray-800 text-white pt-16 pb-8">
    <div class="container mx-auto px-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-12">
            <!-- Company Info -->
            <div>
                <div class="flex items-center gap-2 mb-6">
                    <img src="https://static.readdy.ai/image/37ac7cf2068439d6c30c12e5ad957f85/cf039908287dcf84123e6dde02bea2bc.png" alt="Honda Logo" class="h-8">
                    <h3 class="text-xl font-bold text-primary">Maosaji Honda</h3>
                </div>
                <p class="text-gray-400 mb-6">Authorized Honda motorcycle service center providing professional maintenance to keep your bike performing at its best.</p>
                <div class="flex space-x-4">
                    <a href="#" class="w-10 h-10 rounded-full bg-gray-700 hover:bg-primary transition-colors duration-300 flex items-center justify-center">
                        <i class="ri-facebook-fill"></i>
                    </a>
                    <a href="#" class="w-10 h-10 rounded-full bg-gray-700 hover:bg-primary transition-colors duration-300 flex items-center justify-center">
                        <i class="ri-twitter-fill"></i>
                    </a>
                    <a href="#" class="w-10 h-10 rounded-full bg-gray-700 hover:bg-primary transition-colors duration-300 flex items-center justify-center">
                        <i class="ri-instagram-line"></i>
                    </a>
                    <a href="#" class="w-10 h-10 rounded-full bg-gray-700 hover:bg-primary transition-colors duration-300 flex items-center justify-center">
                        <i class="ri-youtube-fill"></i>
                    </a>
                </div>
            </div>
            <!-- Quick Links -->
            <div>
                <h4 class="text-lg font-semibold mb-6">Quick Links</h4>
                <ul class="space-y-3">
                    <li><a href="#my-vehicles" class="text-gray-400 hover:text-white transition-colors duration-300">My Vehicles</a></li>
                    <li><a href="#add-vehicle" class="text-gray-400 hover:text-white transition-colors duration-300">Add Vehicle</a></li>
                    <li><a href="#my-services" class="text-gray-400 hover:text-white transition-colors duration-300">My Services</a></li>
                    <li><a href="#profile" class="text-gray-400 hover:text-white transition-colors duration-300">Profile</a></li>
                </ul>
            </div>
            <!-- Services (Can link to specific dashboard sections or external service pages) -->
            <div>
                <h4 class="text-lg font-semibold mb-6">Our Services</h4>
                <ul class="space-y-3">
                    <li><a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">Oil Change</a></li>
                    <li><a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">Brake Service</a></li>
                    <li><a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">Diagnostics</a></li>
                    <li><a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">Battery Service</a></li>
                    <li><a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">Engine Repair</a></li>
                    <li><a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">A/C Service</a></li>
                </ul>
            </div>
            <!-- Newsletter -->
            <div>
                <h4 class="text-lg font-semibold mb-6">Newsletter</h4>
                <p class="text-gray-400 mb-6">Subscribe to our newsletter for the latest service offers and automotive tips.</p>
                <form class="mb-4">
                    <div class="flex">
                        <input type="email" placeholder="Your email address" class="px-4 py-3 bg-gray-700 text-white border-none rounded-l focus:outline-none focus:ring-2 focus:ring-primary flex-grow">
                        <button type="submit" class="px-4 py-3 bg-primary text-white rounded-r hover:bg-blue-600 transition-colors duration-300">
                            <i class="ri-send-plane-fill"></i>
                        </button>
                    </div>
                </form>
                <div class="flex items-center">
                    <div class="custom-switch" id="newsletter-switch">
                        <div class="switch-track"></div>
                        <div class="switch-thumb"></div>
                    </div>
                    <span class="ml-2 text-gray-400">Receive promotional emails</span>
                </div>
            </div>
        </div>
        <div class="pt-8 border-t border-gray-700 flex flex-col md:flex-row justify-between items-center">
            <p class="text-gray-400 text-center md:text-left mb-4 md:mb-0">© 2025 AutoCare Pro. All rights reserved.</p>
            <div class="flex space-x-6">
                <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">Privacy Policy</a>
                <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">Terms of Service</a>
                <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">Cookie Policy</a>
            </div>
        </div>
    </div>
</footer>

<!-- Mobile Menu Script -->
<script id="mobile-menu-script">
document.addEventListener('DOMContentLoaded', function() {
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    mobileMenuButton.addEventListener('click', function() {
        mobileMenu.classList.toggle('hidden');
    });
    // Close mobile menu when clicking on a link
    const mobileLinks = mobileMenu.querySelectorAll('a');
    mobileLinks.forEach(link => {
        link.addEventListener('click', function() {
            mobileMenu.classList.add('hidden');
        });
    });
});
</script>

<!-- Loading Screen Script -->
<script id="loading-screen-script">
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        const loadingScreen = document.getElementById('loading-screen');
        loadingScreen.style.opacity = '0';
        setTimeout(function() {
            loadingScreen.style.display = 'none';
        }, 500);
    }, 2000); // Display loading screen for 2 seconds
});
</script>

<!-- Scroll Animation Script -->
<script id="scroll-animation-script">
document.addEventListener('DOMContentLoaded', function() {
    const fadeElements = document.querySelectorAll('.fade-in');
    function checkFade() {
        fadeElements.forEach(element => {
            const elementTop = element.getBoundingClientRect().top;
            const elementBottom = element.getBoundingClientRect().bottom;
            const isVisible = (elementTop < window.innerHeight - 100) && (elementBottom > 0);
            if (isVisible) {
                element.classList.add('appear');
            }
        });
    }
    // Initial check
    checkFade();
    // Check on scroll
    window.addEventListener('scroll', checkFade);
});
</script>

<!-- Dashboard Specific Scripts -->
<script id="dashboard-script">
    // Define the base URL for your deployed backend
    const BASE_URL = 'https://honda-backend-ezro.onrender.com'; // Replace with your actual Render URL

    // Helper function to display custom messages (success/error)
    function showMessage(message, type = 'success') {
        const msgBox = document.getElementById('custom-message-box');
        msgBox.textContent = message;
        msgBox.className = `message-box show ${type}`; // Add 'show' and type class
        setTimeout(() => {
            msgBox.classList.remove('show');
            setTimeout(() => msgBox.classList.add('hidden'), 500); // Hide after fade out
        }, 3000); // Message visible for 3 seconds
        msgBox.classList.remove('hidden'); // Ensure it's not hidden if re-shown quickly
    }

    // Function to get JWT token from local storage
    function getToken() {
        return localStorage.getItem('token');
    }

    // Function to decode JWT token and get user info (basic, for client-side display)
    function decodeToken(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (error) {
            console.error("Error decoding token:", error);
            return null;
        }
    }

    // Function to check authentication and redirect if no token
    function checkAuthAndRedirect() {
        const token = getToken();
        if (!token) {
            showMessage('You are not logged in. Redirecting to login page.', 'error');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1500); // Redirect after 1.5 seconds
            return false;
        }
        return true;
    }

    // Function to update the visibility of the "no vehicles" message
    const updateNoVehiclesMessage = () => {
        const vehiclesList = document.getElementById('vehicles-list');
        const noVehiclesMessage = document.getElementById('no-vehicles-message');
        if (vehiclesList.children.length === 0) {
            noVehiclesMessage.classList.remove('hidden');
        } else {
            noVehiclesMessage.classList.add('hidden');
        }
    };

    // Function to update the visibility of the "no service history" message
    const updateNoServiceHistoryMessage = () => {
        const serviceHistoryList = document.getElementById('service-history-list');
        const noServiceHistoryMessage = document.getElementById('no-service-history-message');
        if (serviceHistoryList.children.length === 0) {
            noServiceHistoryMessage.classList.remove('hidden');
        } else {
            noServiceHistoryMessage.classList.add('hidden');
        }
    };

    // Function to render a single vehicle card
    function renderVehicleCard(vehicle) {
        const vehicleCardHtml = `
            <div class="vehicle-card bg-gray-50 p-6 rounded-lg shadow-sm flex flex-col justify-between">
                <div>
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4 vehicle-icon">
                            <i class="ri-motorcycle-line ri-xl text-primary"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800">${vehicle.make} ${vehicle.model}</h3>
                    </div>
                    <ul class="text-gray-600 space-y-2 text-sm">
                        <li><span class="font-medium">Make:</span> ${vehicle.make}</li>
                        <li><span class="font-medium">Model:</span> ${vehicle.model}</li>
                        <li><span class="font-medium">Year:</span> ${vehicle.year || 'N/A'}</li>
                        <li><span class="font-medium">License Plate:</span> ${vehicle.licensePlate}</li>
                        <li><span class="font-medium">Vehicle ID:</span> ${vehicle._id}</li>
                    </ul>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <!-- Edit functionality can be added later -->
                    <!-- <button class="px-3 py-2 bg-blue-500 text-white rounded-button text-sm hover:bg-blue-600 transition-colors">
                        <i class="ri-edit-line"></i> Edit
                    </button> -->
                    <button data-vehicle-id="${vehicle._id}" class="delete-vehicle-btn px-3 py-2 bg-red-500 text-white rounded-button text-sm hover:bg-red-600 transition-colors">
                        <i class="ri-delete-bin-line"></i> Delete
                    </button>
                </div>
            </div>
        `;
        return vehicleCardHtml;
    }

    // Function to fetch and display user's vehicles
    async function fetchAndDisplayVehicles() {
        const vehiclesList = document.getElementById('vehicles-list');
        vehiclesList.innerHTML = ''; // Clear existing vehicles

        const token = getToken();
        if (!token) return; // Should be handled by checkAuthAndRedirect, but good defensive check

        try {
            const response = await fetch(`${BASE_URL}/api/vehicles`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'x-auth-token': token
                }
            });

            const data = await response.json();

            if (response.ok) {
                if (data.length > 0) {
                    data.forEach(vehicle => {
                        vehiclesList.insertAdjacentHTML('beforeend', renderVehicleCard(vehicle));
                    });
                }
            } else {
                showMessage(data.msg || 'Failed to fetch vehicles.', 'error');
            }
        } catch (error) {
            console.error('Error fetching vehicles:', error);
            showMessage('Network error while fetching vehicles.', 'error');
        } finally {
            updateNoVehiclesMessage(); // Update message visibility after fetch attempt
        }
    }

    // Function to render a single service history item
    function renderServiceHistoryItem(service) {
        const serviceDate = new Date(service.date).toLocaleDateString();
        const serviceCost = service.cost ? `₹${service.cost.toFixed(2)}` : 'N/A';
        // Ensure status class matches backend 'type' values (e.g., 'pending', 'in-progress')
        const serviceStatusClass = `status-${service.type.toLowerCase().replace(/\s/g, '-')}`; 

        // Check if vehicleId is populated and access its properties
        const vehicleInfo = service.vehicleId ?
            `${service.vehicleId.make} ${service.vehicleId.model} (${service.vehicleId.licensePlate})` :
            'Unknown Vehicle';

        const serviceItemHtml = `
            <div class="bg-gray-50 p-4 rounded-lg shadow-sm mb-4 flex justify-between items-center">
                <div>
                    <p class="font-medium text-gray-800">${vehicleInfo} - ${service.type}</p>
                    <p class="text-sm text-gray-600">Service Date: ${serviceDate}</p>
                    <p class="text-sm text-gray-600">Description: ${service.description || 'No description provided'}</p>
                    <p class="text-sm text-gray-600">Cost: ${serviceCost}</p>
                </div>
                <span class="px-3 py-1 text-sm font-medium rounded-full ${serviceStatusClass}">
                    ${service.type.replace(/-/g, ' ')}
                </span>
            </div>
        `;
        return serviceItemHtml;
    }

    // Function to fetch and display user's services (history and current)
    async function fetchAndDisplayServices() {
        const serviceHistoryList = document.getElementById('service-history-list');
        serviceHistoryList.innerHTML = ''; // Clear existing services

        const currentServiceStatusContainer = document.getElementById('current-service-status-container');
        const noCurrentServiceMessage = document.getElementById('no-current-service-message');

        currentServiceStatusContainer.classList.add('hidden'); // Hide if previously shown
        noCurrentServiceMessage.classList.remove('hidden'); // Show initially

        const token = getToken();
        if (!token) return;

        try {
            const response = await fetch(`${BASE_URL}/api/services`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'x-auth-token': token
                }
            });

            const data = await response.json();

            if (response.ok) {
                if (data.length > 0) {
                    // Sort services by date descending (most recent first)
                    data.sort((a, b) => new Date(b.date) - new Date(a.date));

                    let hasCurrentService = false;
                    // Find the most recent service that is NOT 'picked-up' for current status
                    const currentService = data.find(service => service.type.toLowerCase() !== 'picked-up');

                    if (currentService) {
                        hasCurrentService = true;
                        const latestServiceDate = new Date(currentService.date).toLocaleDateString();
                        const latestServiceStatusClass = `status-${currentService.type.toLowerCase().replace(/\s/g, '-')}`; 
                        
                        const vehicleInfoLatest = currentService.vehicleId ?
                            `${currentService.vehicleId.make} ${currentService.vehicleId.model} (${currentService.vehicleId.licensePlate})` :
                            'Unknown Vehicle';

                        // Display current service status
                        currentServiceStatusContainer.innerHTML = `
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Current Servicing Status</h3>
                            <div class="bg-blue-50 p-6 rounded-lg border border-blue-200 flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-4">
                                <div class="w-12 h-12 bg-blue-200 rounded-full flex items-center justify-center text-blue-700 flex-shrink-0">
                                    <i class="ri-dashboard-line text-2xl"></i>
                                </div>
                                <div class="flex-grow">
                                    <p class="text-gray-700 font-medium text-lg">Your ${vehicleInfoLatest} Service:</p>
                                    <span class="font-bold text-xl ${latestServiceStatusClass}">
                                        ${currentService.type.replace(/-/g, ' ')}
                                    </span>
                                    <span class="text-gray-500 text-sm ml-2">(Service Date: ${latestServiceDate})</span>
                                    <p class="text-gray-600 text-sm mt-1">Details: ${currentService.description || 'No description provided'}</p>
                                    <p class="text-gray-600 text-sm">Estimated Cost: ${currentService.cost ? `₹${currentService.cost.toFixed(2)}` : 'N/A'}</p>
                                </div>
                            </div>
                        `;
                        currentServiceStatusContainer.classList.remove('hidden');
                        noCurrentServiceMessage.classList.add('hidden'); // Hide if a current service is displayed
                    }
                    
                    if (!hasCurrentService) {
                         noCurrentServiceMessage.classList.remove('hidden'); // Ensure message is visible if no current service
                    }

                    // Always display all services in history
                    data.forEach(service => {
                        serviceHistoryList.insertAdjacentHTML('beforeend', renderServiceHistoryItem(service));
                    });
                }
            } else {
                showMessage(data.msg || 'Failed to fetch service history.', 'error');
            }
        } catch (error) {
            console.error('Error fetching services:', error);
            showMessage('Network error while fetching services.', 'error');
        } finally {
            updateNoServiceHistoryMessage(); // Update message visibility after fetch attempt
        }
    }


    document.addEventListener('DOMContentLoaded', function() {
        // Redirect to login if not authenticated
        if (!checkAuthAndRedirect()) {
            return; // Stop execution if not authenticated
        }

        // Set user name from token (if available)
        const token = getToken();
        if (token) {
            const decoded = decodeToken(token);
            if (decoded && decoded.user && decoded.user.name) {
                document.getElementById('user-name').textContent = decoded.user.name;
            } else if (decoded && decoded.user && decoded.user.id) {
                // If name is not in token, display user ID (or fetch profile data)
                document.getElementById('user-name').textContent = decoded.user.id.substring(0, 8) + '...';
            }
        }


        // Fetch and display data on page load
        fetchAndDisplayVehicles();
        fetchAndDisplayServices(); // Ensure this is called to load services

        // Logout functionality
        const logoutButton = document.getElementById('logout-button');
        const logoutButtonMobile = document.getElementById('logout-button-mobile');

        const performLogout = () => {
            localStorage.removeItem('token'); // Remove JWT token
            showMessage('Logged out successfully. Redirecting to home page.', 'success');
            setTimeout(() => {
                window.location.href = 'index.html'; // Redirect to index page
            }, 1500);
        };

        if (logoutButton) {
            logoutButton.addEventListener('click', performLogout);
        }
        if (logoutButtonMobile) {
            logoutButtonMobile.addEventListener('click', performLogout);
        }


        // Show/Hide Add Vehicle Form
        const showAddVehicleButton = document.getElementById('show-add-vehicle-form');
        const addVehicleFormSection = document.getElementById('add-vehicle');
        if (showAddVehicleButton && addVehicleFormSection) {
            showAddVehicleButton.addEventListener('click', function() {
                addVehicleFormSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                document.getElementById('vehicle-make').focus();
            });
        }

        // Handle Add Vehicle Form Submission
        const addVehicleForm = document.getElementById('add-vehicle-form');

        addVehicleForm.addEventListener('submit', async function(e) {
            e.preventDefault(); // Prevent default form submission

            const make = document.getElementById('vehicle-make').value.trim();
            const model = document.getElementById('vehicle-model').value.trim();
            const year = parseInt(document.getElementById('vehicle-year').value.trim()); // Parse year as number
            const licensePlate = document.getElementById('license-plate').value.trim();

            // Client-side validation
            if (!make || !model || !year || !licensePlate) {
                showMessage('Please fill in all vehicle details.', 'error');
                return;
            }
            if (isNaN(year) || year < 1900 || year > 2099) {
                showMessage('Please enter a valid year (e.g., 2020).', 'error');
                return;
            }

            const token = getToken();
            if (!token) {
                showMessage('Authentication token missing. Please log in again.', 'error');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/vehicles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-auth-token': token // Include the JWT token
                    },
                    body: JSON.stringify({ make, model, year, licensePlate })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('Vehicle added successfully!', 'success');
                    addVehicleForm.reset(); // Clear the form
                    fetchAndDisplayVehicles(); // Refresh the list of vehicles
                    fetchAndDisplayServices(); // Also refresh services as a new vehicle might get a service
                } else {
                    showMessage(data.msg || 'Failed to add vehicle.', 'error');
                }
            } catch (error) {
                console.error('Error adding vehicle:', error);
                showMessage('Network error while adding vehicle.', 'error');
            }
        });

        // Handle Delete Vehicle Button Click (Event Delegation)
        document.getElementById('vehicles-list').addEventListener('click', async function(event) {
            const deleteButton = event.target.closest('.delete-vehicle-btn');
            if (deleteButton) {
                const vehicleId = deleteButton.dataset.vehicleId;

                // Show custom confirmation modal
                const confirmationModal = document.getElementById('confirmation-modal');
                const confirmYes = document.getElementById('confirm-yes');
                const confirmNo = document.getElementById('confirm-no');
                const modalTitle = document.getElementById('confirmation-modal-title');
                const modalMessage = document.getElementById('confirmation-modal-message');

                modalTitle.textContent = 'Confirm Deletion';
                modalMessage.textContent = 'Are you sure you want to delete this vehicle? This action cannot be undone.';
                confirmationModal.classList.add('show');

                // Use promises to wait for user's decision
                const userConfirmed = await new Promise(resolve => {
                    confirmYes.onclick = () => {
                        confirmationModal.classList.remove('show');
                        resolve(true);
                    };
                    confirmNo.onclick = () => {
                        confirmationModal.classList.remove('show');
                        resolve(false);
                    };
                });

                if (!userConfirmed) {
                    return; // User cancelled deletion
                }

                const token = getToken();
                if (!token) {
                    showMessage('Authentication token missing. Please log in again.', 'error');
                    return;
                }

                try {
                    const response = await fetch(`${BASE_URL}/api/vehicles/${vehicleId}`, {
                        method: 'DELETE',
                        headers: {
                            'x-auth-token': token // Include the JWT token
                        }
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showMessage('Vehicle deleted successfully!', 'success');
                        fetchAndDisplayVehicles(); // Refresh the list of vehicles
                        fetchAndDisplayServices(); // Refresh services as a vehicle might be deleted
                    } else {
                        showMessage(data.msg || 'Failed to delete vehicle.', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting vehicle:', error);
                    showMessage('Network error while deleting vehicle.', 'error');
                }
            }
        });

    });
</script>

<!-- Navbar Scroll Effect Script -->
<script id="navbar-scroll-script">
document.addEventListener('DOMContentLoaded', function() {
    const navbar = document.getElementById('navbar');
    function handleScroll() {
        if (window.scrollY > 50) {
            navbar.classList.add('py-2');
            navbar.classList.add('shadow-lg');
        } else {
            navbar.classList.remove('py-2');
            navbar.classList.remove('shadow-lg');
        }
    }
    window.addEventListener('scroll', handleScroll);
});
</script>

<!-- Smooth Scroll Script -->
<script id="smooth-scroll-script">
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            if (targetId === '#') return;
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
                window.scrollTo({
                    top: targetElement.offsetTop - 80, /* Adjust for fixed header height */
                    behavior: 'smooth'
                });
            }
        });
    });
});
</script>
</body>
</html>
